---
// src/pages/intro.astro
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RATIONS - Standard Issue Seasonings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .terminal {
            width: 90%;
            max-width: 900px;
            height: 80vh;
            background: #1a1a1a;
            border: 3px solid #333;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 
                0 0 25px rgba(0, 255, 0, 0.15),
                inset 0 0 25px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            touch-action: none;
        }

        .terminal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 0, 0.04) 2px,
                    rgba(0, 255, 0, 0.04) 4px
                );
            pointer-events: none;
        }

        .terminal-content {
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .typewriter-text {
            font-size: 19px;
            line-height: 1.7;
            white-space: pre-wrap;
            color: #00ff00;
            letter-spacing: 1.2px;
            text-shadow: 0 0 3px rgba(0, 255, 0, 0.3);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.1s ease-out;
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 21px;
            background: #00ff00;
            animation: blink 1s infinite;
            margin-left: 1px;
            box-shadow: 0 0 4px rgba(0, 255, 0, 0.4);
            vertical-align: baseline;
            position: relative;
            top: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .skip-hint {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #666;
            font-size: 13px;
            text-align: center;
            opacity: 0.7;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            backdrop-filter: blur(5px);
            font-family: 'Courier New', monospace;
            transition: opacity 0.3s ease;
        }

        .skip-hint:hover {
            opacity: 1;
        }

        .skip-hint::before {
            content: "Click to skip";
        }

        .website {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 35% 65%, rgba(107, 142, 35, 0.12) 0%, transparent 50%),
                linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 1.2s ease;
            color: #f5f5dc;
            text-align: center;
            z-index: 2000;
        }

        .website.show {
            opacity: 1;
            visibility: visible;
        }

        .logo {
            font-size: 4.2rem;
            font-weight: bold;
            letter-spacing: 10px;
            color: #8FBC8F;
            margin-bottom: 25px;
            text-shadow: 
                3px 3px 0px #2F4F2F,
                6px 6px 12px rgba(0, 0, 0, 0.6);
        }

        .tagline {
            font-size: 1.6rem;
            margin-bottom: 45px;
            color: #d2b48c;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .enter-btn {
            background: linear-gradient(135deg, #8FBC8F 0%, #6B8E23 100%);
            color: #1a1a1a;
            border: 2px solid #556B2F;
            padding: 18px 35px;
            font-size: 1.3rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.4s ease;
            letter-spacing: 3px;
            text-transform: uppercase;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .enter-btn:hover {
            background: linear-gradient(135deg, #9ACD32 0%, #7BA428 100%);
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .terminal {
                padding: 25px 20px;
                width: 100%;
                height: 100vh;
                border-radius: 0;
                border: 2px solid #333;
            }
            
            .typewriter-text {
                font-size: 16px;
                line-height: 1.6;
                letter-spacing: 1px;
            }
            
            .cursor {
                height: 18px;
            }
            
            .skip-hint {
                top: 15px;
                right: 15px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .logo {
                font-size: 3rem;
                letter-spacing: 6px;
            }
            
            .tagline {
                font-size: 1.3rem;
                letter-spacing: 2px;
            }
            
            .enter-btn {
                padding: 15px 25px;
                font-size: 1.1rem;
                letter-spacing: 2px;
            }
        }

        @media (max-width: 480px) {
            .typewriter-text {
                font-size: 14px;
                line-height: 1.5;
            }
            
            .cursor {
                height: 16px;
            }
            
            .skip-hint {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 5px 8px;
            }
            
            .logo {
                font-size: 2.5rem;
                letter-spacing: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="terminal-content" id="terminal-container">
            <div class="typewriter-text" id="content">
                <span class="cursor" id="cursor"></span>
            </div>
        </div>
    </div>

    <div class="skip-hint" id="skip-hint">Click to skip</div>

    <div class="website" id="website">
        <div class="logo">RATIONS</div>
        <div class="tagline">Standard Issue</div>
        <button class="enter-btn" onclick="window.location.href='/supply-depot'">Enter Supply Depot</button>
    </div>

    <script>
        // @ts-nocheck
        const content = document.getElementById('content');
        const cursor = document.getElementById('cursor');
        const terminalContainer = document.getElementById('terminal-container');
        const skipHint = document.getElementById('skip-hint');
        let isSkipped = false;
        let currentIndex = 0;
        let audioContext = null;
        let scrollOffset = 0;
        let isCorrectingClassification = false;
        let remainingTextAfterCorrection = '';

        const text = `> ACCESSING CLASSIFIED TERMINAL...
> LOGIN SUCCESSFUL
> RETRIEVING FILE: PROJECT_FLAVOR.txt

========================================
CONFIDENTIAL - EYES ONLY
========================================

PROJECT: OPERATION FLAVOR SUPERIORITY
DATE: ${new Date().toLocaleDateString()}
CLEARANCE: LEVEL 7

MISSION BRIEF:

For too long, home cooks have been forced to 
use substandard seasonings. Generic blends.
Bland combinations. Flavorless disasters.

NO MORE.

Our research division has spent years perfecting
the ultimate tactical seasoning solution.

BREAKTHROUGH ACHIEVED.

Product: RATIONS SPICE BLEND
Code Name: "STANDARD ISSUE"
Classification: FIELD TESTED âœ“
Deployment Status: AUTHORIZED

CAPABILITIES:
- Transforms any protein instantly
- Elevates vegetables beyond recognition  
- Makes rice actually exciting
- Turns basic meals into memorable experiences
- Compatible with ALL cooking methods

Field testing across 847 kitchens shows:
- 340% improvement in meal satisfaction
- 89% reduction in bland food incidents
- 100% success rate in flavor enhancement

This isn't just seasoning.
This is culinary domination.

Whether you're grilling steaks, roasting chicken,
seasoning vegetables, or cooking pasta...
STANDARD ISSUE delivers tactical flavor superiority.

MISSION PARAMETERS:
Deploy on everything. Leave no meal unseasoned.

CLASSIFICATION: CLASSIFIED
AUTHORIZATION: APPROVED FOR PUBLIC RELEASE

The flavor revolution begins now.

What makes STANDARD ISSUE legendary?

That's still classified.

> TRANSMISSION COMPLETE
> INITIALIZING SUPPLY DEPOT ACCESS...`;

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Audio context created:', audioContext.state);
            } catch (e) {
                console.log('Audio not available:', e);
            }
        }

        function ensureAudioContext() {
            if (!audioContext) {
                initAudio();
            }
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log('Audio context resumed');
                });
            }
        }

        function playSubtleClick() {
            ensureAudioContext();
            if (!audioContext || audioContext.state !== 'running') return;
            
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.setValueAtTime(400 + Math.random() * 200, audioContext.currentTime);
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0, audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(0.05, audioContext.currentTime + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.08);
                
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.08);
            } catch (e) {
                console.log('Click sound failed:', e);
            }
        }

        function playSystemChime() {
            ensureAudioContext();
            if (!audioContext || audioContext.state !== 'running') return;
            
            try {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.setValueAtTime(500, audioContext.currentTime);
                osc.frequency.linearRampToValueAtTime(600, audioContext.currentTime + 0.1);
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0, audioContext.currentTime);
                gain.gain.linearRampToValueAtTime(0.06, audioContext.currentTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
                
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Chime sound failed:', e);
            }
        }

        function autoScroll() {
            const containerHeight = terminalContainer.clientHeight;
            const cursorPosition = cursor.offsetTop + cursor.offsetHeight;
            
            // Calculate smooth scroll position
            const targetScroll = Math.max(0, cursorPosition - containerHeight + 60);
            
            if (targetScroll > 0) {
                const currentTransform = content.style.transform;
                const currentY = currentTransform ? parseInt(currentTransform.match(/-?\d+/)?.[0] || '0') : 0;
                const newY = -targetScroll;
                
                // Only update if we need to scroll more
                if (Math.abs(newY - currentY) > 5) {
                    content.style.transform = `translateY(${newY}px)`;
                }
            }
        }

        function getCurrentText() {
            let textContent = '';
            for (let node of content.childNodes) {
                if (node !== cursor && node.nodeType === Node.TEXT_NODE) {
                    textContent += node.textContent;
                }
            }
            return textContent;
        }

        function type() {
            if (isSkipped || currentIndex >= text.length) {
                finish();
                return;
            }

            const char = text[currentIndex];
            
            // Insert character before cursor
            const textNode = document.createTextNode(char);
            content.insertBefore(textNode, cursor);
            
            // Check if we just finished typing "CLASSIFICATION: CLASSIFIED"
            // Look for the exact position in the original text
            const classifiedPosition = text.indexOf('CLASSIFICATION: CLASSIFIED');
            const classifiedEnd = classifiedPosition + 'CLASSIFICATION: CLASSIFIED'.length;
            
            if (currentIndex === classifiedEnd - 1 && !isCorrectingClassification) {
                isCorrectingClassification = true;
                
                console.log('Starting classification correction at index:', currentIndex);
                
                // Store the remaining text after this point
                remainingTextAfterCorrection = text.substring(currentIndex + 1);
                
                // Start correction after a pause
                setTimeout(() => {
                    if (!isSkipped) {
                        startClassificationCorrection();
                    }
                }, 800);
                return;
            }
            
            // Enhanced audio feedback
            if (char === '>') {
                playSystemChime();
            } else if (char !== ' ' && char !== '\n' && char !== '=') {
                playSubtleClick();
            }
            
            // Smooth auto-scroll every few characters for better performance
            if (currentIndex % 3 === 0) {
                requestAnimationFrame(() => autoScroll());
            }
            
            currentIndex++;
            
            let delay = 30;
            if (char === '\n') delay = 100;
            else if (char === '.' || char === ':' || char === '!') delay = 80;
            else if (char === ' ') delay = 15;
            else if (char === '>') delay = 180;
            
            setTimeout(() => type(), delay + Math.random() * 10);
        }

        function startClassificationCorrection() {
            console.log('Starting classification correction');
            
            const currentText = getCurrentText();
            const beforeClassifiedIndex = currentText.lastIndexOf('CLASSIFICATION: ');
            
            if (beforeClassifiedIndex === -1) {
                console.log('Could not find CLASSIFICATION: in text');
                continueTypingAfterCorrection();
                return;
            }
            
            const beforeClassified = currentText.substring(0, beforeClassifiedIndex + 'CLASSIFICATION: '.length);
            console.log('Before classified text:', beforeClassified);
            
            // Start backspacing "CLASSIFIED"
            backspaceClassified(beforeClassified, 'CLASSIFIED', 0);
        }

        function backspaceClassified(beforeText, wordToBackspace, backspaceCount) {
            if (backspaceCount >= wordToBackspace.length || isSkipped) {
                console.log('Finished backspacing, starting to type DECLASSIFIED');
                // Start typing "DECLASSIFIED"
                setTimeout(() => {
                    if (!isSkipped) {
                        typeNewClassification(beforeText, 'DECLASSIFIED', 0);
                    }
                }, 150);
                return;
            }
            
            const remainingWord = wordToBackspace.substring(0, wordToBackspace.length - backspaceCount - 1);
            console.log('Backspacing:', beforeText + remainingWord);
            
            // Clear all text and rebuild with the partial word
            while (content.firstChild && content.firstChild !== cursor) {
                content.removeChild(content.firstChild);
            }
            
            const textNode = document.createTextNode(beforeText + remainingWord);
            content.insertBefore(textNode, cursor);
            
            requestAnimationFrame(() => autoScroll());
            
            setTimeout(() => {
                backspaceClassified(beforeText, wordToBackspace, backspaceCount + 1);
            }, 60);
        }

        function typeNewClassification(beforeText, newWord, charIndex) {
            if (charIndex >= newWord.length || isSkipped) {
                console.log('Finished typing DECLASSIFIED, continuing with remaining text');
                // Correction complete, continue with remaining text
                setTimeout(() => {
                    if (!isSkipped) {
                        continueTypingAfterCorrection();
                    }
                }, 200);
                return;
            }
            
            const partialWord = newWord.substring(0, charIndex + 1);
            console.log('Typing:', beforeText + partialWord);
            
            // Clear all text and rebuild with the new partial word
            while (content.firstChild && content.firstChild !== cursor) {
                content.removeChild(content.firstChild);
            }
            
            const textNode = document.createTextNode(beforeText + partialWord);
            content.insertBefore(textNode, cursor);
            
            playSubtleClick();
            requestAnimationFrame(() => autoScroll());
            
            setTimeout(() => {
                typeNewClassification(beforeText, newWord, charIndex + 1);
            }, 80);
        }

        function continueTypingAfterCorrection() {
            console.log('Continuing with remaining text:', remainingTextAfterCorrection.substring(0, 50) + '...');
            
            // Continue typing the remaining text character by character
            let remainingIndex = 0;
            
            function typeRemainingChar() {
                if (remainingIndex >= remainingTextAfterCorrection.length || isSkipped) {
                    console.log('Finished typing all remaining text');
                    finish();
                    return;
                }
                
                const char = remainingTextAfterCorrection[remainingIndex];
                const textNode = document.createTextNode(char);
                content.insertBefore(textNode, cursor);
                
                if (char === '>') {
                    playSystemChime();
                } else if (char !== ' ' && char !== '\n' && char !== '=') {
                    playSubtleClick();
                }
                
                if (remainingIndex % 3 === 0) {
                    requestAnimationFrame(() => autoScroll());
                }
                
                remainingIndex++;
                
                let delay = 30;
                if (char === '\n') delay = 100;
                else if (char === '.' || char === ':' || char === '!') delay = 80;
                else if (char === ' ') delay = 15;
                else if (char === '>') delay = 180;
                
                setTimeout(typeRemainingChar, delay + Math.random() * 10);
            }
            
            typeRemainingChar();
        }

        function finish() {
            if (isSkipped) {
                // Clear content and add all text with DECLASSIFIED correction
                while (content.firstChild && content.firstChild !== cursor) {
                    content.removeChild(content.firstChild);
                }
                const correctedText = text.replace('CLASSIFICATION: CLASSIFIED', 'CLASSIFICATION: DECLASSIFIED');
                const textNode = document.createTextNode(correctedText);
                content.insertBefore(textNode, cursor);
                requestAnimationFrame(() => autoScroll());
            }
            
            // Hide cursor and skip hint
            cursor.style.display = 'none';
            skipHint.style.opacity = '0';
            setTimeout(() => showWebsite(), 2000);
        }

        function showWebsite() {
            document.querySelector('.terminal').style.transform = 'scale(0.85) rotateX(3deg)';
            document.querySelector('.terminal').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('website').classList.add('show');
            }, 500);
        }

        function skip() {
            if (isSkipped) return;
            isSkipped = true;
            finish();
        }

        function handleFirstInteraction() {
            ensureAudioContext();
            skip();
        }

        document.addEventListener('click', handleFirstInteraction);
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                handleFirstInteraction();
            }
        });

        // Prevent manual scrolling
        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        document.addEventListener('wheel', (e) => e.preventDefault(), { passive: false });

        window.addEventListener('load', () => {
            setTimeout(() => {
                initAudio();
                type();
            }, 1000);
        });
    </script>
</body>
</html>